# Add Cognito Groups to Amplify Cloudformation Templates

Amplify provides a set of @directives that allow us te restrit who can access what:

```graphql
type Post @model @auth(rules: [{allow: owner}]) {
  id: ID!
  title: String!
}
```

In this example, we are restricting access to the post by the user that created the post in the first place. This is done by the magical marriage of Cognito and the API.

## Groups

Cognito also allows us to create groups and then add users to those groups. This allows us to easily add a collection of permissions to a group and this will filter down to the users of that group. This is really useful for applying access rules to the data in our database.

The example below uses a draft entity. We want to allow the Draft's owner to create, read, update, and delete Draft objects. Finally, we want users that are members of the Admin group to be able to do everything. This would be represented in our schema like this:

```graphql
type Draft
  @model
  @auth(rules: [
    # Default to use the "owner" field.
    {allow: owner},

    # Authorize the update mutation and both queries. Use `queries: null` to disable auth for queries.
    {allow: owner, ownerField: "editors", operations: [update]},

    # Admin users can access any operation.
    {allow: groups, groups: ["Admin"]}
  ]) {
    id: ID!
    title: String!
    content: String
    owner: String
    editors: [String]!
  }
```

## Create Groups

Cognito groups allow us to easily control permissions on a large number of users. Cognito groups can be created in the AWS console, but that poses a problem. We are not creating this in code and so it cannot be put into version control. Also, when we add/update our Amplify stack these groups are probably going to be overwritten.

The solution to this is to get Cloudformation to create the groups for us when we are making any updates to our Amplify application.

This can be done by editing the Cloudformation templates that are generated by Amplify. But we need to be careful with which ones we update as some are auto generated whenever we use the Amplify CLI.

### The file that we need to edit will be [projectname]/amplify/backend/auth/[appname]/[appname]-cloudformation-template.yml

```yaml
Resources:
  ## Other resources...
  ## ...
  UserPoolGroupAdmins:
    Type: 'AWS::Cognito::UserPoolGroup'
    Properties:
      GroupName: Admins
      UserPoolId: !Ref UserPool
  UserPoolGroupUsers:
    Type: 'AWS::Cognito::UserPoolGroup'
    Properties:
      GroupName: Users
      UserPoolId: !Ref UserPool
  UserPoolGroupGuests:
    Type: 'AWS::Cognito::UserPoolGroup'
    Properties:
      GroupName: Guests
      UserPoolId: !Ref UserPool
```

The above code creates three Cognito groups: Admins, Users, and Guests. Once we have deployed these changes, they can be used throughout our applications, and in our example above the Admin group can perform all of the operations on the draft entity.